<!-- 75be2392-2df2-4fee-b68a-a43ae7019c8e 3bd1d628-2292-4d3d-8eac-bc973953d8bd -->
# План работ по улучшению системы консультаций

## Приоритет 1: Критические улучшения (фундамент)

### 1.1. Добавление регистра закрытия очереди для консультантов

**Файлы:** `FastAPI/models.py`, `FastAPI/catalog_scripts/pull_queue_closing_cl.py` (новый), `FastAPI/services/manager_selector.py`, `FastAPI/services/manager_notifications.py`

**Задачи:**

- Создать модель `QueueClosing` в `FastAPI/models.py` для таблицы `cons.queue_closing` (PK: `(period, manager_key)`)
- Создать ETL скрипт `pull_queue_closing_cl.py` для загрузки из `InformationRegister_ЗакрытиеОчередиНаКонсультанта`
- Добавить проверку закрытия очереди в `ManagerSelector.get_available_managers()` - исключать менеджеров с закрытой очередью на текущую дату
- При закрытии очереди: оставить существующие консультации как есть, ждать переназначения через ETL от руководителя
- При обнаружении закрытия очереди через ETL: отправлять уведомление клиентам о скором переназначении менеджера/консультанта
- При переназначении менеджера через ETL: обновлять в БД и Chatwoot

**Зависимости:** Нет

---

### 1.2. Улучшение автоматического выбора менеджера

**Файлы:** `FastAPI/services/manager_selector.py`

**Задачи:**

- Добавить расчет статистики среднего времени закрытия заявок из БД (среднее между `start_date` и `end_date` для закрытых консультаций по менеджеру)
- Улучшить алгоритм выбора: распределять консультации между несколькими менеджерами, а не только одному
- Использовать статистику для расчета времени ожидания:
- Если данных нет - использовать дефолт 15 минут на заявку
- Если статистика показывает меньше 15 минут - использовать минимум 15 минут на заявку
- Показывать клиенту: минимум 15 минут, максимум 15 минут * количество консультаций в очереди
- Обновить `calculate_wait_time()` для использования реальной статистики с учетом минимума 15 минут

**Зависимости:** 1.1 (для учета закрытия очереди)

---

### 1.3. Уведомления клиентов об изменениях очереди

**Файлы:** `FastAPI/services/manager_notifications.py`, `FastAPI/routers/webhooks.py`, `FastAPI/routers/consultations.py`, `FastAPI/catalog_scripts/pull_queue_closing_cl.py`, `FastAPI/catalog_scripts/pull_cons_cl.py`

**Задачи:**

- Расширить `send_queue_update_notification()` для отправки уведомлений при каждом изменении очереди
- Добавить вызов уведомлений при создании консультации (уже частично реализовано)
- Добавить вызов уведомлений при переназначении менеджера через webhook от Chatwoot (в `FastAPI/routers/webhooks.py`)
- Добавить вызов уведомлений при переназначении менеджера через ETL из ЦЛ (в `pull_cons_cl.py`)
- Добавить вызов уведомлений при закрытии очереди менеджера (сообщать о скором переназначении)

**Зависимости:** 1.1, 1.2

---

### 1.4. Уведомления о переносах, оценках и дозвонах

**Файлы:** `FastAPI/catalog_scripts/pull_cons_redate_cl.py`, `FastAPI/catalog_scripts/pull_cons_rates_cl.py`, `FastAPI/catalog_scripts/pull_calls_cl.py`, `FastAPI/routers/consultations.py`, `FastAPI/services/chatwoot_client.py`

**Задачи:**

- Проверить видимость note-сообщений клиенту в Chatwoot (параметр `private=False` в `send_note()`)
- Если note-сообщения не видны клиенту: отправлять как обычное сообщение от имени пользователя с доступом к API (использовать `send_message()` вместо `send_note()`)
- Добавить уведомления клиентам при оценках через API только если оценка приходит из ЦЛ (в `POST /api/consultations/{cons_id}/ratings`)
- Убедиться, что все изменения синхронизируются с 1C:ЦЛ и Chatwoot

**Зависимости:** Нет (частично уже реализовано)

---

## Приоритет 2: Обработка заявок (консультаций)

### 2.1. Язык консультации

**Файлы:** `FastAPI/models.py`, `FastAPI/schemas/tickets.py`, `FastAPI/routers/consultations.py`, `FastAPI/routers/dicts.py`

**Задачи:**

- Поле `lang` уже существует в модели `Consultation` и схемах
- Поддержка языков `ru` и `uz` уже реализована
- Язык `en` пока не добавлять (планируется на будущее, когда появится в ЦЛ)
- Обновить `GET /api/dicts/online-question/categories` и `GET /api/dicts/online-questions` для фильтрации по языку (уже реализовано)
- Убедиться, что язык сохраняется при создании консультации

**Зависимости:** Нет

---

### 2.2. Маппинг раздела ПО (оставить po_type_key)

**Файлы:** `FastAPI/schemas/tickets.py`, `FastAPI/routers/consultations.py`, `FastAPI/services/manager_selector.py`

**Задачи:**

- Поле `po_type_key` оставить в схемах (будет использоваться для маппинга)
- Поле `po_section_key` можно удалить из API создания консультаций (если не используется)
- Обновить `ManagerSelector` для работы с `po_type_key` и `category_key`

**Зависимости:** Нет

---

### 2.3. Маппинг ПО для фронтенда

**Файлы:** `FastAPI/routers/dicts.py`, `FastAPI/schemas/dicts.py`

**Задачи:**

- Создать упрощенную схему `POTypeReadSimple` для фронтенда (только необходимые поля)
- Обновить `GET /api/dicts/po-types` для возврата упрощенных данных
- Убрать лишние поля из ответа API

**Зависимости:** Нет

---

### 2.4. Вид обращения для консультаций

**Файлы:** `FastAPI/models.py`, `FastAPI/schemas/tickets.py`, `FastAPI/routers/consultations.py`, `FastAPI/services/onec_client.py`, `FastAPI/catalog_scripts/pull_cons_cl.py`

**Задачи:**

- Добавить поле `consultation_type` (Text) в модель `Consultation` (миграция Alembic)
- Добавить поле в схемы `ConsultationCreate` и `ConsultationRead`
- Определить маппинг значений: "Техническая поддержка" / "Консультация по ведению учёта"
- Добавить фильтрацию: отправлять в ЦЛ только консультации с типом "Консультация по ведению учёта"
- НЕ указывать вид обращения в POST запросах к OData (фильтрация происходит на стороне middleware)
- Обновить ETL `pull_cons_cl.py` для загрузки только консультаций, где у контрагента Parent_Key = "7ccd31ca-887b-11eb-938b-00e04cd03b68" или родитель "Clobus"
- Если фильтрация по Parent_Key невозможна в OData - реализовать фильтрацию после загрузки в БД

**Зависимости:** Требует проверки возможности фильтрации в OData

---

### 2.5. Отмена консультаций (улучшение)

**Файлы:** `FastAPI/routers/consultations.py` (уже реализовано), `FastAPI/models.py`

**Задачи:**

- Endpoint `POST /api/consultations/{cons_id}/cancel` уже реализован
- Убедиться, что поле `denied` корректно сохраняется в БД
- Убедиться, что отмена синхронизируется с 1C:ЦЛ и Chatwoot (уже реализовано)

**Зависимости:** Нет (уже реализовано)

---

## Приоритет 3: Создание клиентов в 1C:ЦЛ

### 3.1. Создание клиентов с Parent_Key и ЮридическоеФизическоеЛицо

**Файлы:** `FastAPI/services/onec_client.py`, `FastAPI/routers/clients.py`

**Задачи:**

- Обновить `create_client_odata()` для добавления параметра `Parent_Key: "7ccd31ca-887b-11eb-938b-00e04cd03b68"`
- Добавить определение типа лица по ИНН:
- 9 знаков → "Юридическое лицо"
- 14 знаков → "Физическое лицо"
- Добавить параметр `ЮридическоеФизическоеЛицо` в payload создания клиента
- Обновить `_ensure_owner_synced_with_cl()` для использования новых параметров

**Зависимости:** Нет

---

## Приоритет 4: ETL и инфраструктура

### 4.1. Фильтрация пользователей в ETL

**Файлы:** `FastAPI/catalog_scripts/pull_users_cl.py`

**Задачи:**

- Добавить фильтрацию пользователей по полям:
- `DeletionMark: true` - не загружать
- `Недействителен: true` - не загружать
- `Служебный: true` - не загружать
- Не загружать отключенных пользователей в БД
- Не синхронизировать отключенных пользователей с Chatwoot

**Зависимости:** Нет

---

### 4.2. Настройка cron для ETL

**Файлы:** `dockerfile`, `docker-compose.yml`, `FastAPI/catalog_scripts/run_all_etl.py`, `entrypoint.sh`, `crontab` (новый)

**Задачи:**

- Добавить cron в Dockerfile (установка пакета cron)
- Создать файл `crontab` с расписанием запуска ETL скриптов:
- `pull_cons_cl.py` - каждые N часов
- `pull_cons_redate_cl.py` - каждые N часов
- `pull_cons_rates_cl.py` - каждые N часов
- `pull_calls_cl.py` - каждые N часов
- `pull_users_cl.py` - ежедневно
- `pull_queue_closing_cl.py` - каждые N часов
- Обновить `entrypoint.sh` для запуска cron сервиса
- Настроить логирование выполнения cron задач

**Зависимости:** Нет

---

### 4.3. Ограничения на создание заявок на будущее

**Файлы:** `FastAPI/routers/consultations.py`, `FastAPI/config.py`

**Задачи:**

- Добавить проверку максимальной даты создания консультации (например, не более 30 дней вперед)
- Добавить конфигурационный параметр `MAX_FUTURE_CONSULTATION_DAYS` в `config.py`
- Валидировать `scheduled_at` при создании консультации
- Вернуть понятную ошибку клиенту при превышении лимита

**Зависимости:** Нет

---

## Порядок выполнения

1. **Неделя 1:** Приоритет 1 (1.1, 1.2, 1.3, 1.4)
2. **Неделя 2:** Приоритет 2 (2.1, 2.2, 2.3, 2.4, 2.5)
3. **Неделя 3:** Приоритет 3 (3.1) + Приоритет 4 (4.1, 4.2, 4.3)
4. **Неделя 4:** Тестирование, исправление багов, документация

---

## Риски и неопределенности

1. **Вид обращения:** Требует проверки возможности фильтрации по Parent_Key в OData
2. **Note сообщения:** Требует проверки видимости note-сообщений клиенту в Chatwoot
3. **Статистика времени:** Требует проверки наличия достаточного количества данных для расчета

---

## Тестирование

Для каждой задачи необходимо:

1. Unit тесты для бизнес-логики
2. Integration тесты для API endpoints
3. Ручное тестирование с реальными данными из 1C:ЦЛ
4. Проверка синхронизации между системами

### To-dos

- [ ] Создать модель QueueClosing в models.py для таблицы cons.queue_closing
- [ ] Создать ETL скрипт pull_queue_closing_cl.py для загрузки InformationRegister_ЗакрытиеОчередиНаКонсультанта
- [ ] Добавить проверку закрытия очереди в ManagerSelector.get_available_managers()
- [ ] Добавить уведомления клиентам при закрытии очереди менеджера (сообщать о скором переназначении)
- [ ] Добавить расчет статистики среднего времени закрытия заявок из БД в ManagerSelector
- [ ] Обновить calculate_wait_time() для использования минимума 15 минут на консультацию
- [ ] Улучшить алгоритм выбора менеджера для распределения между несколькими менеджерами
- [ ] Добавить уведомления при переназначении менеджера через webhook от Chatwoot
- [ ] Добавить уведомления при переназначении менеджера через ETL из ЦЛ
- [ ] Проверить видимость note-сообщений клиенту в Chatwoot, при необходимости использовать send_message()
- [ ] Добавить уведомления клиентам при оценках через API только если оценка из ЦЛ
- [ ] Оставить po_type_key в схемах для будущего маппинга
- [ ] Создать упрощенную схему POTypeReadSimple для фронтенда
- [ ] Добавить поле consultation_type в модель Consultation и схемы
- [ ] Добавить фильтрацию: отправлять в ЦЛ только консультации с типом Консультация по ведению учёта
- [ ] Обновить ETL pull_cons_cl.py для фильтрации по Parent_Key или родителю Clobus
- [ ] Обновить create_client_odata() для добавления Parent_Key и ЮридическоеФизическоеЛицо
- [ ] Добавить фильтрацию пользователей по DeletionMark, Недействителен, Служебный в pull_users_cl.py
- [ ] Настроить cron для автоматического запуска ETL процессов
- [ ] Добавить ограничение на создание заявок на будущее (максимум N дней)