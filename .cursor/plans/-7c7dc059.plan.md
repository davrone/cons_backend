<!-- 7c7dc059-0165-48a1-913b-8c5b7a1d292b 13ec5a47-76d8-4b8d-939b-466e4d7c907d -->
# План оставшихся задач по проекту

## Текущее состояние

### ✅ Выполнено

- Основной функционал создания консультаций
- ETL скрипты для загрузки данных из 1C:ЦЛ
- API для справочников, клиентов, консультаций
- Вебхуки Chatwoot (частично)
- Синхронизация с Chatwoot и 1C:ЦЛ
- Docker и миграции Alembic

### ✅ Недавно выполнено

- ✅ Добавлен `chatwoot_source_id` в ответы API (`POST /api/consultations/create` и `GET /api/consultations/{cons_id}`)
- ✅ Доделан ETL оценок с обработкой `ДатаОценки` из OData
- ✅ Исправлена отправка оценки/переноса в ЦЛ (валидация `manager_key`, улучшено логирование)
- ✅ Отображение дозвонов в Chatwoot при ETL (автоматическая отправка note-сообщений)
- ✅ Отображение переносов/оценок в Chatwoot при ETL (автоматическая отправка note-сообщений)
- ✅ API endpoint для просмотра дозвонов (`GET /api/consultations/{cons_id}/calls`)
- ✅ Таблица маппинга менеджеров (`sys.user_mapping`) и обновление вебхуков
- ✅ Перепроверено создание заявок/консультаций/бесед в ЦЛ и Chatwoot
- ✅ Обновлена архитектура и API документация
- ✅ Исправлена ошибка `MultipleResultsFound` в `get_client_by_subscriber` (обработка множественных владельцев с одинаковым `code_abonent`)

---

## Приоритет 1: Критичные задачи (ближайшие 1-2 недели)

### 1. Добавить chatwoot_source_id в ответы API

**Файлы:**

- `FastAPI/routers/consultations.py` (endpoint `create_consultation` и `get_consultation`)
- `FastAPI/schemas/tickets.py` (проверить схему `ConsultationResponse`)

**Задачи:**

- Убедиться, что `chatwoot_source_id` возвращается в `POST /api/consultations/create`
- Добавить `chatwoot_source_id` в ответ `GET /api/consultations/{cons_id}`
- Проверить, что поле правильно заполняется при создании консультации (уже есть в коде, но нужно проверить возврат)

**Оценка:** 30 минут

---

### ✅ 2. Доделать ETL оценок с обработкой ДатаОценки (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/catalog_scripts/pull_cons_rates_cl.py`
- `FastAPI/models.py` (проверить модель `ConsRatingAnswer`)

**Задачи:**

- Добавить обработку поля `ДатаОценки` из OData ответа
- Обработать случай, когда `ДатаОценки` = "0001-01-01T00:00:00" (старые данные) - пропускать или использовать текущую дату
- При отправке оценки через API устанавливать `ДатаОценки` в текущую дату
- Использовать `ДатаОценки` как `Period` для синхронизации (вместо или вместе с существующим Period)
- Обновить логику сохранения в `cons.cons_rating_answers`

**Оценка:** 1.5 часа

---

### ✅ 3. Исправить отправку оценки/переноса в ЦЛ (ошибка 400) (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/services/onec_client.py` (методы отправки переноса и оценки)
- `FastAPI/routers/consultations.py` (endpoints создания переноса/оценки)

**Задачи:**

- Исследовать ошибку 400 Bad Request при отправке переноса/оценки
- Проверить формат данных, отправляемых в 1C OData
- Убедиться, что `Менеджер_Key` не равен "FRONT" (должен быть валидный GUID)
- Проверить формат дат (должны быть в правильном формате для 1C)
- Добавить валидацию перед отправкой
- Улучшить логирование ошибок с полным телом запроса и ответа

**Оценка:** 2 часа

---

### ✅ 4. Отображение дозвонов в Chatwoot при ETL (ВЫПОЛНЕНО)

**Файлы:** `FastAPI/catalog_scripts/pull_calls_cl.py`

**Задачи:**

- Добавить отправку note-сообщений в Chatwoot при обнаружении новых дозвонов
- Использовать `ChatwootClient` для отправки note с информацией о попытке дозвона
- Проверять наличие `cons_id` перед отправкой

**Оценка:** 30 минут

---

### ✅ 5. Отображение переносов/оценок в Chatwoot при ETL (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/catalog_scripts/pull_cons_redate_cl.py`
- `FastAPI/catalog_scripts/pull_cons_rates_cl.py`

**Задачи:**

- Добавить отправку note-сообщений в Chatwoot при обнаружении новых переносов/оценок
- Использовать логику аналогичную API endpoints (см. `FastAPI/routers/consultations.py`)

**Оценка:** 1 час

---

### ✅ 6. API endpoint для просмотра дозвонов (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/routers/consultations.py` (добавить endpoint)
- `FastAPI/schemas/consultation.py` (добавить схему)

**Задачи:**

- Создать `GET /api/consultations/{cons_id}/calls`
- Возвращать список попыток дозвона из `cons.calls`
- Фильтрация по дате, менеджеру (опционально)
- Добавить схему `CallRead` в `FastAPI/schemas/consultation.py`

**Оценка:** 1 час

---

### ✅ 7. Таблица маппинга менеджеров (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/models.py` (добавить модель `UserMapping`)
- `FastAPI/alembic/versions/` (создать миграцию)
- `FastAPI/routers/webhooks.py` (использовать маппинг)

**Задачи:**

- Создать модель `sys.user_mapping` с полями:
- `chatwoot_user_id` (Integer, FK к Chatwoot)
- `cl_manager_key` (Text, ключ менеджера в ЦЛ)
- `created_at`, `updated_at`
- Создать миграцию Alembic
- Обновить вебхук обработчик для использования маппинга при синхронизации статусов

**Оценка:** 1.5 часа

---

### ✅ 8. Перепроверить создание заявок/консультаций/бесед в ЦЛ и Chatwoot (ВЫПОЛНЕНО)

### ✅ 9. Исправить ошибку MultipleResultsFound в get_client_by_subscriber (ВЫПОЛНЕНО)

**Файлы:**

- `FastAPI/routers/clients.py`

**Задачи:**

- Исправить обработку случая, когда найдено несколько владельцев с одинаковым `code_abonent`
- Добавить сортировку по `created_at` и выбор первого (самого старого) владельца
- Добавить логирование предупреждения при обнаружении множественных владельцев

**Оценка:** 15 минут

**Файлы:**

- `FastAPI/routers/consultations.py` (endpoint `create_consultation`)
- `FastAPI/services/chatwoot_client.py`
- `FastAPI/services/onec_client.py`

**Задачи:**

- Проверить весь процесс создания консультации от начала до конца
- Убедиться, что данные корректно сохраняются в БД
- Проверить создание conversation в Chatwoot (все поля, custom attributes, labels)
- Проверить создание документа в 1C:ЦЛ (все обязательные поля, правильный формат)
- Проверить обновление записей после получения ID из внешних систем
- Добавить дополнительные проверки и логирование

**Оценка:** 2 часа

---

## Приоритет 2: Важные улучшения (2-4 недели)

### 9. Автоматический выбор менеджеров (операторов/консультантов)

**Файлы:**

- `FastAPI/services/operator_selector.py` (создать или обновить)
- `FastAPI/routers/consultations.py` (использовать селектор)

**Задачи:**

- Реализовать автоматический выбор менеджера из `cons.users` по критериям:
- Выбранные вопросы (категории вопросов из `cons.users_skill`)
- Языки консультации (ru/uz из `cons.users`)
- Формат заявки (source: SITE, TELEGRAM, CALL_CENTER)
- Учитывать только менеджеров с лимитами (`con_limit` в `cons.users`)
- Учитывать, что лимиты могут меняться в любой момент (проверять актуальные значения)
- Интегрировать в процесс создания консультации (заменить `_get_default_manager_key`)

**Оценка:** 4 часа

---

### 10. Настройка автоматического запуска ETL (cron/airflow)

**Файлы:**

- Создать скрипты для запуска ETL
- Настроить cron или docker-compose с scheduler

**Задачи:**

- Выбрать решение: cron (проще) или airflow (сложнее, но мощнее)
- Рекомендация: использовать cron для простоты обслуживания
- Настроить расписание для всех ETL скриптов:
- `pull_cons_cl.py` - каждые N минут/часов
- `pull_cons_redate_cl.py` - каждые N минут
- `pull_cons_rates_cl.py` - каждые N минут
- `pull_calls_cl.py` - каждые N минут
- `pull_users_cl.py` - реже (раз в день)
- `load_dicts.py` - реже (раз в день или при изменении)
- Добавить логирование и мониторинг выполнения
- Обеспечить идемпотентность (можно запускать параллельно)

**Оценка:** 2 часа

---

### 11. Дополнительные поля в моделях

**Файлы:**

- `FastAPI/models.py` (обновить `Consultation`, `Client`)
- `FastAPI/alembic/versions/` (миграция)
- `FastAPI/schemas/` (обновить схемы)

**Задачи:**

- В `cons.cons` добавить:
- `topic` (Text) — тема консультации
- `source` (Text) — источник создания (SITE, TELEGRAM, CALL_CENTER)
- `priority` (Integer) — приоритет
- `tags` (JSONB) — теги из Chatwoot
- `custom_attributes` (JSONB) — дополнительные атрибуты
- В `cons.clients` добавить:
- `chatwoot_contact_id` (Integer) — ID контакта в Chatwoot
- `company_name` уже есть, проверить использование

**Оценка:** 2 часа

---

### 12. Retry логика для создания консультаций

**Файлы:**

- `FastAPI/routers/consultations.py` (endpoint `create_consultation`)

**Задачи:**

- Добавить retry с backoff при ошибках создания в Chatwoot/ЦЛ
- Сохранять failed attempts в отдельную таблицу для последующей обработки
- Использовать существующую логику backoff из `FastAPI/services/onec_client.py`

**Оценка:** 2 часа

---

### 13. API для истории изменений

**Файлы:**

- `FastAPI/routers/consultations.py` (добавить endpoint)
- `FastAPI/schemas/consultation.py` (схема истории)

**Задачи:**

- Создать `GET /api/consultations/{cons_id}/history`
- Возвращать историю: статусы, переносы, оценки, дозвоны
- Объединить данные из `cons.cons_redate`, `cons.cons_rating_answers`, `cons.calls`

**Оценка:** 2 часа

---

### 14. Улучшение вебхуков

**Файлы:**

- `FastAPI/routers/webhooks.py`

**Задачи:**

- Обработка `message.created` — сохранение в `cons.q_and_a` или отдельную таблицу
- Обработка `conversation.assigned` — обновление менеджера с использованием маппинга
- Обработка `conversation.typing` — статус набора текста (опционально)

**Оценка:** 2 часа

---

### 15. Обновить архитектуру и API документацию

**Файлы:**

- `ARCHITECTURE.md`
- `API_DOCUMENTATION.md`
- `ROADMAP.md` (обновить статус выполненных задач)

**Задачи:**

- Обновить `ARCHITECTURE.md` с учетом всех изменений:
- Новые поля в моделях
- Автоматический выбор менеджеров
- Обновленная логика ETL
- Маппинг менеджеров
- Обновить `API_DOCUMENTATION.md`:
- Добавить новые endpoints
- Обновить примеры запросов/ответов
- Добавить информацию о `chatwoot_source_id`
- Обновить `ROADMAP.md` - отметить выполненные задачи
- Проверить актуальность всех диаграмм и примеров

**Оценка:** 3 часа

---

## Приоритет 3: Долгосрочные задачи (по необходимости)

### 16. Валидация OpenID токена

**Статус:** На паузе (ожидает настройки 1C:Фреш)

**Файлы:**

- `FastAPI/routers/auth.py`
- `FastAPI/dependencies/security.py`

**Задачи:**

- Получить issuer URL и JWKS endpoint от 1C:Фреш
- Реализовать валидацию JWT токена
- Интегрировать с существующей системой авторизации

**Оценка:** 4 часа (после получения данных от 1C:Фреш)

---

### 17. Улучшение кэширования

**Файлы:**

- `FastAPI/routers/dicts.py`
- `FastAPI/services/` (если нужен Redis)

**Задачи:**

- Инвалидация кэша при обновлении справочников через ETL
- Опционально: Redis для распределенного кэширования

**Оценка:** 2 часа

---

### 18. Оптимизация ETL

**Файлы:**

- `FastAPI/catalog_scripts/*.py`

**Задачи:**

- Параллельная загрузка нескольких справочников
- Batch processing для больших объемов данных
- Мониторинг производительности ETL

**Оценка:** 4 часа

---

### 19. Мониторинг и метрики

**Файлы:**

- `FastAPI/main.py` (добавить Prometheus)
- Новые файлы для метрик

**Задачи:**

- Prometheus метрики (количество запросов, время ответа, ошибки)
- Health checks для внешних сервисов (Chatwoot, 1C:ЦЛ)
- Алерты при недоступности сервисов

**Оценка:** 4 часа

---

### 20. Тестирование

**Файлы:**

- Создать `tests/` директорию
- Unit тесты для сервисов
- Integration тесты для API

**Задачи:**

- Unit тесты для `chatwoot_client`, `onec_client`
- Integration тесты для основных endpoints
- E2E тесты для основных сценариев

**Оценка:** 8 часов

---

### 21. Безопасность

**Файлы:**

- `FastAPI/main.py` (CORS)
- Новые middleware для rate limiting

**Задачи:**

- Ограничение CORS для продакшена (сейчас `allow_origins=["*"]`)
- Rate limiting для API
- Валидация входных данных (sanitization)

**Оценка:** 3 часа

---

### 22. Производительность

**Файлы:**

- `FastAPI/database.py` (connection pooling)
- Миграции для индексов

**Задачи:**

- Оптимизация connection pooling
- Индексы БД для частых запросов
- Оптимизация запросов к справочникам

**Оценка:** 3 часа

---

### 23. Очистка кода

**Файлы:**

- `FastAPI/routers/tickets.py` (deprecated)

**Задачи:**

- Удалить `FastAPI/routers/tickets.py` (deprecated, заменен на `consultations.py`)
- Очистить неиспользуемые схемы
- Обновить документацию

**Оценка:** 1 час

---

### 24. Документация

**Файлы:**

- `FastAPI/routers/*.py` (добавить OpenAPI аннотации)
- `API_DOCUMENTATION.md` (обновить)

**Задачи:**

- Swagger/OpenAPI аннотации для всех endpoints
- Примеры запросов/ответов в документации
- Диаграммы последовательности для основных процессов

**Оценка:** 4 часа

---

## Рекомендуемый порядок выполнения

### ✅ Неделя 1 (ВЫПОЛНЕНО)

1. ✅ Добавить chatwoot_source_id в ответы API (задача 1)
2. ✅ Доделать ETL оценок с обработкой ДатаОценки (задача 2)
3. ✅ Исправить отправку оценки/переноса в ЦЛ (задача 3)
4. ✅ Перепроверить создание заявок (задача 8)
5. ✅ Исправить ошибку MultipleResultsFound в get_client_by_subscriber (задача 9)

### ✅ Неделя 2 (ВЫПОЛНЕНО)

5. ✅ Отображение дозвонов в Chatwoot при ETL (задача 4)
6. ✅ Отображение переносов/оценок в Chatwoot при ETL (задача 5)
7. ✅ API endpoint для просмотра дозвонов (задача 6)
8. ✅ Таблица маппинга менеджеров (задача 7)
9. ✅ Обновить архитектуру и API документацию (задача 15)

### Неделя 3-4

9. Автоматический выбор менеджеров (задача 9)
10. Настройка автоматического запуска ETL (задача 10)
11. Дополнительные поля в моделях (задача 11)
12. Retry логика для создания консультаций (задача 12)
13. API для истории изменений (задача 13)
14. Улучшение вебхуков (задача 14)
15. Обновить архитектуру и API документацию (задача 15)

### Неделя 5+

16. Остальные задачи по приоритету и необходимости

---

## Заметки

- **OpenID валидация:** Ожидает настройки 1C:Фреш от пользователя
- **Кэширование:** Сейчас in-memory, можно перейти на Redis при масштабировании
- **ETL расписание:** Настроить cron для автоматического запуска ETL (задача 10)
- **Логирование:** Рассмотреть централизованное логирование (ELK, Loki)
- **Автоматический выбор менеджеров:** Важная задача, требует тщательной проработки логики выбора с учетом лимитов
- **Множественные владельцы:** Исправлена обработка случая, когда в БД есть несколько владельцев с одинаковым `code_abonent`. Теперь возвращается самый старый (по `created_at`) с предупреждением в логах.