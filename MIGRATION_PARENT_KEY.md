# Миграция: Добавление parent_key в clients

## Проблема

- ETL загружает всех клиентов из всех папок ЦЛ → в БД попадают cl_ref_key от клиентов из чужих папок
- При обновлении/создании система находит клиента по ИНН без проверки Parent_Key → либо меняет чужого клиента, либо создает дубль
- cl_ref_key указывает на удаленные дубли → поиск не работает, создаются новые дубли

## Решение

Добавление поля `parent_key` в таблицу `clients` для идентификации папки клиента в ЦЛ.

## Что было сделано

1. **Миграция БД** - добавлено поле `parent_key` в таблицу `cons.clients`
2. **Скрипт миграции данных** - для обновления `parent_key` у существующих клиентов
3. **Поиск в ЦЛ** - теперь всегда ищем ТОЛЬКО в папке CLOBUS (`Parent_Key="7ccd31ca-887b-11eb-938b-00e04cd03b68"`)
4. **Синхронизация с ЦЛ** - сохраняем `parent_key` при создании/обновлении клиента
5. **ETL** - загружаем `parent_key` для всех клиентов из ЦЛ

## Порядок применения миграции

### 1. Применить миграцию Alembic

```bash
cd FastAPI
alembic upgrade head
```

Это добавит поле `parent_key` в таблицу `clients` и создаст индексы.

### 2. Запустить скрипт миграции данных

```bash
python FastAPI/catalog_scripts/migrate_client_parent_keys.py
```

**Что делает скрипт:**

1. **Обработка клиентов с cl_ref_key:**
   - Запрашивает Parent_Key из ЦЛ по cl_ref_key
   - Сохраняет parent_key в БД
   - Если Parent_Key != "7ccd31ca-887b-11eb-938b-00e04cd03b68" → сбрасывает cl_ref_key в NULL
   - Если клиент не найден в ЦЛ → сбрасывает cl_ref_key в NULL

2. **Обработка клиентов без cl_ref_key (но с code+inn):**
   - Ищет клиента в папке CLOBUS по code_abonent + org_inn
   - Если найден → связывает (устанавливает cl_ref_key и parent_key)

**Ожидаемый результат:**
- ~3000 клиентов из папки CLOBUS получат правильный parent_key
- ~17000 клиентов из других папок получат их parent_key и потеряют cl_ref_key (будут проигнорированы при синхронизации)

**ВАЖНО:** Скрипт работает с ЦЛ через OData API. Убедитесь, что ЦЛ доступен и настроены переменные окружения:
- `ODATA_BASEURL_CL`
- `ODATA_USER`
- `ODATA_PASSWORD`

### 3. Перезапустить контейнеры

```bash
docker-compose down
docker-compose up -d --build
```

Или для продакшна:

```bash
docker-compose -f docker-compose.prod.yml down
docker-compose -f docker-compose.prod.yml up -d --build
```

## Логика работы после миграции

### Создание/обновление клиента

1. Клиент приходит с фронта (новый или существующий)
2. Система ищет клиента в ЦЛ по `code_abonent + org_inn + Parent_Key="7ccd31ca-887b-11eb-938b-00e04cd03b68"`
3. **Если найден в папке CLOBUS:**
   - Обновляет существующего клиента
   - Сохраняет `cl_ref_key` и `parent_key`
4. **Если найден в ДРУГОЙ папке:**
   - Игнорируется (фильтр по Parent_Key исключает его из результатов)
   - Создается НОВЫЙ клиент в папке CLOBUS (контролируемый дубль)
5. **Если не найден:**
   - Создается новый клиент в папке CLOBUS
   - Сохраняет `cl_ref_key` и `parent_key`

### ETL загрузка клиентов

1. Загружает всех клиентов из ЦЛ (без фильтра по Parent_Key)
2. Сохраняет `parent_key` для каждого клиента
3. Клиенты с `parent_key != "7ccd31ca-887b-11eb-938b-00e04cd03b68"` не будут обновляться/изменяться при синхронизации с фронта

## Преимущества решения

1. **Нет потери данных клиентов** - все данные (ИНН, email, phone, история заявок) сохраняются
2. **Контролируемые дубли** - если клиент существует в другой папке, создается дубль в папке CLOBUS
3. **Изоляция папок** - клиенты из разных отделов не пересекаются
4. **Полный контекст** - ETL загружает всех клиентов для расчета очередей, но синхронизирует только свою папку

## Проверка результатов

### После миграции проверьте:

```sql
-- Сколько клиентов в папке CLOBUS
SELECT COUNT(*) FROM cons.clients 
WHERE parent_key = '7ccd31ca-887b-11eb-938b-00e04cd03b68';

-- Сколько клиентов в других папках
SELECT COUNT(*) FROM cons.clients 
WHERE parent_key IS NOT NULL AND parent_key != '7ccd31ca-887b-11eb-938b-00e04cd03b68';

-- Сколько клиентов без parent_key (еще не обработаны или созданы через фронт)
SELECT COUNT(*) FROM cons.clients 
WHERE parent_key IS NULL;

-- Распределение клиентов по папкам
SELECT parent_key, COUNT(*) as count 
FROM cons.clients 
WHERE parent_key IS NOT NULL 
GROUP BY parent_key 
ORDER BY count DESC;
```

## Откат миграции (если нужно)

```bash
cd FastAPI
alembic downgrade -1
```

Это удалит поле `parent_key` и индексы. **ВНИМАНИЕ:** Данные в поле будут потеряны.
